<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        Spring切面编程 - Ming Blog
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="1.切面编程核心概念 切面编程Aspect-oriented Programming (AOP) AOP只是一个概念，跟Spring是独立关系 最典型的AOP实现框架Aspect" />
    <meta name="generator" content="Hugo 0.74.3 with theme pure" />
    <title>Spring切面编程 - Ming Blog</title>
    
    
    <link rel="stylesheet" href="http://www.mingaccount.com/css/style.min.7dc20efbc53647d41aa9ddea0c48e59300223d084e66ea0cbe7c30bd88903acc.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:title" content="Spring切面编程" />
<meta property="og:description" content="1.切面编程核心概念 切面编程Aspect-oriented Programming (AOP) AOP只是一个概念，跟Spring是独立关系 最典型的AOP实现框架Aspect" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.mingaccount.com/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/" />
<meta property="article:published_time" content="2017-06-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-06-06T00:00:00+00:00" />
<meta itemprop="name" content="Spring切面编程">
<meta itemprop="description" content="1.切面编程核心概念 切面编程Aspect-oriented Programming (AOP) AOP只是一个概念，跟Spring是独立关系 最典型的AOP实现框架Aspect">
<meta itemprop="datePublished" content="2017-06-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2017-06-06T00:00:00+00:00" />
<meta itemprop="wordCount" content="10027">



<meta itemprop="keywords" content="spring," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring切面编程"/>
<meta name="twitter:description" content="1.切面编程核心概念 切面编程Aspect-oriented Programming (AOP) AOP只是一个概念，跟Spring是独立关系 最典型的AOP实现框架Aspect"/>

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-green" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="" target="_blank">
            <img class="img-circle img-rotate" src="http://www.mingaccount.com/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Ming</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">tianshiming5@outlook.com</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>BeiJing, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/db2/" class="tag-list-link">db2</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/design-pattern/" class="tag-list-link">design-pattern</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/druid/" class="tag-list-link">druid</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/ehcache/" class="tag-list-link">ehcache</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/git/" class="tag-list-link">git</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/h2/" class="tag-list-link">h2</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/hadoop/" class="tag-list-link">hadoop</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/hive/" class="tag-list-link">hive</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/jackson/" class="tag-list-link">jackson</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/java/" class="tag-list-link">java</a><span
                    class="tag-list-count">35</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/jooq/" class="tag-list-link">jooq</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/junit4/" class="tag-list-link">junit4</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/junit5/" class="tag-list-link">junit5</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/linux/" class="tag-list-link">linux</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/lombok/" class="tag-list-link">lombok</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/markdown/" class="tag-list-link">markdown</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/maven/" class="tag-list-link">maven</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/mockmvc/" class="tag-list-link">mockmvc</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/mybatis/" class="tag-list-link">mybatis</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/mysql/" class="tag-list-link">mysql</a><span
                    class="tag-list-count">17</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/npm/" class="tag-list-link">npm</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/oracle/" class="tag-list-link">oracle</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/postgresql/" class="tag-list-link">postgresql</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/python/" class="tag-list-link">python</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/redis/" class="tag-list-link">redis</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/regexp/" class="tag-list-link">regexp</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/scala/" class="tag-list-link">scala</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/spark/" class="tag-list-link">spark</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/spring/" class="tag-list-link">spring</a><span
                    class="tag-list-count">22</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/testng/" class="tag-list-link">testng</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/unit-test/" class="tag-list-link">unit-test</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/website-build/" class="tag-list-link">website-build</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="http://www.mingaccount.com/tags/windows/" class="tag-list-link">windows</a><span
                    class="tag-list-count">4</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="http://www.mingaccount.com/2020/10/windowspngquantfailedtobuild/" class="title">Windows CMD 错误pngquant failed to build, make sure that libpng-dev is installed</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-10-18 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-10-18</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="http://www.mingaccount.com/2020/08/win10/" class="title">WIN10 UBUNTU 异常：sleep: cannot read realtime clock: Invalid argument</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-08-10 13:37:30 &#43;0800 CST" itemprop="datePublished">2020-08-10</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="http://www.mingaccount.com/2020/07/oracleextract%E5%87%BD%E6%95%B0%E6%8F%90%E5%8F%96%E6%97%B6%E5%88%86%E7%A7%92%E7%9A%84%E9%97%AE%E9%A2%98/" class="title">Oracle extract函数提取时分秒的问题</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-07-30 17:42:55 &#43;0800 CST" itemprop="datePublished">2020-07-30</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="http://www.mingaccount.com/2020/07/jooq%E9%BB%98%E8%AE%A4schema/" class="title">JOOQ默认schema</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-07-14 11:16:55 &#43;0800 CST" itemprop="datePublished">2020-07-14</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="http://www.mingaccount.com/2020/06/druid%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%E6%97%A0%E9%99%90%E5%B0%9D%E8%AF%95%E9%97%AE%E9%A2%98/" class="title">Druid数据库连接失败，无限尝试问题</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-06-16 15:38:20 &#43;0800 CST" itemprop="datePublished">2020-06-16</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/"
    >Spring切面编程</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="http://www.mingaccount.com/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/" class="article-date">
  <time datetime="2017-06-06 00:00:00 &#43;0000 UTC" itemprop="datePublished">2017-06-06</time>
</a>
</span>
  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/spring/"> spring </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/#comments"
            class="article-comment-link">Comments</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 10027words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 21minutes </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h1 id="1切面编程核心概念">1.切面编程核心概念</h1>
<blockquote>
<p>切面编程Aspect-oriented Programming (AOP)</p>
</blockquote>
<p>AOP只是一个概念，跟Spring是独立关系<br>
最典型的AOP实现框架<code>AspectJ</code>，是一个十分成熟的框架，Spring AOP相比只是基于它做了一些功能的强化，是互补关系</p>
<p>几个核心的参数概念（基于AspectJ）</p>
<ul>
<li>Aspect: 切面编程的核心是切面，因此首先需要一个切面类(<code>@Aspect</code>注解修饰的类)</li>
<li>Join point: 代表需要切面处理的方法（Spring AOP只针对方法，因此以下简称<em>目标方法</em>）</li>
<li>Advice: 切面类需要在<em>目标方法</em>运行的哪个阶段进行处理，比如<code>before(调用之前)</code>，<code>after(调用之后)</code>，<code>around(前后都进行处理)</code></li>
<li>Pointcut: 当前的切面类需要监听的<em>目标方法</em>有什么特征，或者说切面类要怎样找到需要处理的<em>目标方法</em>，比如被注解<code>@Log</code>修饰的方法</li>
<li>Introduction: 申明一个额外的方法或者字段去代表<em>目标方法</em>的对象，意思就是你可以给<em>目标方法</em>所在类追加一个父类（接口），并指定一个实现去代表它（AspectJ称为inter-type declaration）</li>
<li>Target object: <em>目标方法</em>所在的对象，也叫作<code>advised object</code>。但是Spring AOP是通过运行时代理实现的，意思就是这个对象是一个代理类的对象</li>
</ul>
<p>完整的Advice类型包括：</p>
<ul>
<li>Before advice: 在<em>目标方法</em>之前</li>
<li>After returning advice: 在<em>目标方法</em>return之后，如果<em>目标方法</em>没有抛异常的话</li>
<li>After throwing advice: 在<em>目标方法</em>抛完异常之后</li>
<li>After (finally) advice: 相当于finally</li>
<li>Around advice: 在方法执行前后做处理，可以处理参数，捕获异常，修改返回结果</li>
</ul>
<p>建议使用最小范围的Advice，比如说仅需要处理返回结果，只需要设定类型为<code>After returning advice</code>即可<br>
能不使用<code>Around advice</code>的时候尽量不使用，因为它需要你手动去调用<em>目标方法</em>(通过动态代理)，尽可能地减少出错<br>
Spring AOP默认使用标准的<code>JDK dynamic proxies</code>作为AOP的代理，就是切面类中调用<em>目标方法</em>的过程。</p>
<h1 id="2基于aspectj的spring-aop实例">2.基于AspectJ的Spring AOP实例</h1>
<h2 id="21-配置类">2.1 配置类</h2>
<p>注解<code>EnableAspectJAutoProxy</code>，让Spring在<em>目标方法</em>被执行时，自动拦截方法调用并生成代理类</p>
<pre><code class="language-java">@Configuration
@EnableAspectJAutoProxy
public class AppConfig {
}
</code></pre>
<h2 id="22-切面类声明">2.2 切面类声明</h2>
<p>注意切面类的方法不能作为<em>目标方法</em>被拦截</p>
<pre><code class="language-java">package org.xyz;
import org.aspectj.lang.annotation.Aspect;

@Component
@Aspect
public class NotVeryUsefulAspect {

}
</code></pre>
<h2 id="23-切面方法特征申明pointcut">2.3 切面方法特征申明(Pointcut)</h2>
<p>Spring AOP只支持方法执行的切入点，所以Pointcut就是在申明怎么匹配目标<em>目标方法</em></p>
<p>一个Pointcut的声明有两个部分</p>
<ul>
<li>新建一个方法，任意参数，任意名称，返回值必须是void</li>
<li>新建的方法需要一个<code>@Pointcut</code>注解，这个注解和他的参数叫做pointcut表达式</li>
</ul>
<p>下面是一个例子，代表pointcut的名字是<code>anyOldTransfer</code>，匹配的<em>目标方法</em>是任何方法名叫做<code>transfer</code>的</p>
<pre><code class="language-java">@Pointcut(&quot;execution(* transfer(..))&quot;)
private void andOldTransfer(){}
</code></pre>
<p>注解<code>Pointcut</code>的value就是<code>AspectJ5</code>的pointcut表达式</p>
<h3 id="231-支持的pointcut标识符">2.3.1 支持的Pointcut标识符</h3>
<p>在pointcut表达式中，Spring AOP支持下列的AspectJ pointcut 标识符(PCD)：</p>
<ul>
<li><code>execution</code>: 用于直接匹配<em>目标方法</em>。对Spring AOP来说，这是主要的pointcut指示符</li>
<li><code>within</code>: 限制<em>目标方法</em>是在匹配的类型中申明</li>
<li><code>this</code>: 限制<em>目标方法</em>，其bean引用(Spring AOP代理)是给定类型的实例</li>
<li><code>target</code>: 限制<em>目标方法</em>，其目标对象(正在代理的应用程序对象)是给定类型的实例</li>
<li><code>args</code>: 限制<em>目标方法</em>，其参数是给定类型的实例</li>
<li><code>@target</code>: 限制<em>目标方法</em>，其类有指定类型的注解</li>
<li><code>@args</code>: 限制<em>目标方法</em>，其实际传输的参数，每个参数的类型都有给定的注解</li>
<li><code>@within</code>: 限制<em>目标方法</em>，其所在类型有给定的注解</li>
<li><code>@annotation</code>: 限制<em>目标方法</em>有给定注解</li>
</ul>
<p>在AspectJ中，因为Aspect是一个基于类型的语法，this和target都指向同一个对象。<br>
但在SpringAOP中，this和target是有区别的，Spring AOP是基于代理的系统，this代表的是代理对象，target代表的才是<em>目标方法</em>所在的对象</p>
<blockquote>
<p>Spring不支持以下AspectJ的pointcut标识符：<br>
<code>call, get, set, preinitialization, staticinitialization, initialization, handler, adviceexecution, withincode, cflow, cflowbelow, if, @this, and @withincode</code><br>
如果使用这些pointcut标识符会抛出<code>IllegalArgumentException</code></p>
</blockquote>
<blockquote>
<p>因为Spring AOP以代理为基础的特性，是不会拦截在<em>目标方法</em>所在类中的调用的，换句话说<em>目标方法</em>所在类的其他方法中调用了<em>目标方法</em>是不会触发拦截的 <br>
这个特性是由Spring AOP默认使用的<code>JDK proxies</code>造成的，可以通过替换<code>Spring's proxy-based AOP framework</code>为<a href="https://docs.spring.io/spring/docs/5.2.8.RELEASE/spring-framework-reference/core.html#aop-aj-ltw">Spring-driven native AspectJ weaving</a> 来解决，但是需要对<code>waving</code>有一定熟练度</p>
</blockquote>
<p>Spring AOP支持一个额外的PCD，叫做<code>bean</code>。这个标识符可以让你限制<em>目标方法</em>去匹配一个或多个指定的Spring bean(多个通过通配符)</p>
<pre><code class="language-java">bean(idOrNameOfBean)
</code></pre>
<p><code>idOrNameOfBean</code>可以是任何Spring bean的名称。如果你确定了多个bean名称的规则，可以也只能用<code>*</code>号去写PCD表达式来选择他们<br>
当<code>bean</code>需要和其他的PCD一起使用的时候，同样可以使用<code>&amp;&amp;</code>(and)，<code>!</code>(negation),<code>||</code>(or)来连接</p>
<h3 id="232-组合pointcut表达式">2.3.2 组合pointcut表达式</h3>
<p>你可以组合pointcut表达式通过使用<code>&amp;&amp;</code>，<code>||</code>和<code>!</code></p>
<pre><code class="language-java">@Pointcut(&quot;execution(public * *(..))&quot;)
private void anyPublicOperation(){}

@Pointcut(&quot;within(com.xyz.myapp.trading..*)&quot;)
private void inTrading(){}

@Pointcut(&quot;anyPublicOperation() &amp;&amp; inTrading()&quot;)
private void tradingOperation(){}
</code></pre>
<p>对上面的三个pointcut逐个解析</p>
<ol>
<li><code>anyPublicOperation</code> 匹配任何<em>目标方法</em>是public的</li>
<li><code>inTrading</code> 匹配任何<em>目标方法</em>在<code>trading</code>模块路径下</li>
<li><code>tradingOperation</code> 任何<em>目标方法</em>是public，并且在<code>trading</code>模块下</li>
</ol>
<p>从小的命名组件完成了一个复杂的pointcut表达式的构建，这是一个最好的实现方式，正如上面的实例。<br>
当通过名字引用pointcut，跟一般java的可见规则一样(private,protected,public)，意味着你可以引用其他类的pointcut，只要对应pointcut的类修饰符可见。
pointcut的可见性不影响切面的匹配，只影响pointcut表达式的引用</p>
<h3 id="233-分享共用的pointcut定义">2.3.3 分享共用的Pointcut定义</h3>
<p>在开发中有很多切面是经常使用到的，推荐定义一个<code>CommonPointcuts</code>切面类来定义共用的pointcut表达式<br>
典型的类似下边的这个例子：</p>
<pre><code class="language-java">package com.xyz.myapp;

import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;

@Aspect
public class CommonPointcuts {

    /**
     * 在web层的切面，任何在web目录以及子目录类中定义的方法
     */
    @Pointcut(&quot;within(com.xyz.myapp.web..*)&quot;)
    public void inWebLayer() {}

    /**
     * service层的切面，任何在service目录以及子目录类中定义的方法
     */
    @Pointcut(&quot;within(com.xyz.myapp.service..*)&quot;)
    public void inServiceLayer() {}

    /**
     * dao层的切面，任何在dao目录以及子目录类中定义的方法
     */
    @Pointcut(&quot;within(com.xyz.myapp.dao..*)&quot;)
    public void inDataAccessLayer() {}

    /**
     * 业务Service切面，任何在service接口中定义的方法,假定接口在&quot;service&quot;package中，并且子包中有其实现类
     *
     * 也可以使用bean(*Service)，但是要确保Service的命名规则
     */
    @Pointcut(&quot;execution(* com.xyz.myapp..service.*.*(..))&quot;)
    public void businessService() {}

    /**
     * 任何在dao接口中定义的方法，假定接口在&quot;dao&quot;package中，并且子包有其实现类
     */
    @Pointcut(&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;)
    public void dataAccessOperation() {}

}
</code></pre>
<p>你可以引用这些pointcut定义，在任何你需要他们的地方。举个例子，给所有service层都加上事务，你可以这样写：</p>
<pre><code class="language-xml">&lt;aop:config&gt;
    &lt;aop:advisor
        pointcut=&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;
        advice-ref=&quot;tx-advice&quot;/&gt;
&lt;/aop:config&gt;

&lt;tx:advice id=&quot;tx-advice&quot;&gt;
    &lt;tx:attributes&gt;
        &lt;tx:method name=&quot;*&quot; propagation=&quot;REQUIRED&quot;/&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
</code></pre>
<p>关于具体的&lt;aop:config&gt;和&lt;aop:advisor&gt;元素使用方式可以参考 <a href="https://docs.spring.io/spring/docs/5.2.8.RELEASE/spring-framework-reference/core.html#aop-schema">Schema-based AOP Support</a><br>
关于事务元素的使用可以参考 <a href="https://docs.spring.io/spring/docs/5.2.8.RELEASE/spring-framework-reference/data-access.html#transaction">Transaction Management</a></p>
<h3 id="234-实例">2.3.4 实例</h3>
<p>Spring AOP 的用户最经常使用的pointcut标识符是<code>execution</code>，<code>execution</code>表达式的格式如下：</p>
<pre><code> execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern)
                throws-pattern?)
</code></pre>
<ul>
<li>
<p>以上表达式中，除了<code>ret-type-pattern</code>，<code>name-pattern</code>和<code>param-pattern</code>是必须的，其他的都是可选参数</p>
</li>
<li>
<p><code>ret-type-pattern</code>指代返回类型</p>
<ul>
<li><code>*</code>号是最常用到的，代表可以返回任何类型</li>
<li>一个完全限定的类型名称，只有在方法返回指定类型的时候才会匹配</li>
</ul>
</li>
<li>
<p><code>name-pattern</code> 指代方法名称</p>
<ul>
<li>你可以使用<code>*</code>号来代替部分或者全部方法名</li>
<li>如果你指定了<code>declaring-type-pattern</code>，用<code>.</code>号连接<code>name-component</code></li>
</ul>
</li>
<li>
<p><code>param-pattern</code> 指代方法参数</p>
<ul>
<li><code>()</code>代表方法没有任何参数</li>
<li><code>(..)</code>代表方法可能没有参数，也可能有任意数量任意类型的参数</li>
<li><code>(*)</code> 代表方法有一个任意类型的参数</li>
<li><code>(*,String)</code> 代表方法有两个参数，一个是任意类型，一个必须是String</li>
</ul>
</li>
</ul>
<p>完整的AspectJ pointcut表达式语法结构可以参考<a href="https://www.eclipse.org/aspectj/doc/released/progguide/semantics-pointcuts.html">Language Semantics</a><br>
一下的实例展示了经常使用到的pointcut表达式：</p>
<ul>
<li>任何执行的public方法</li>
</ul>
<blockquote>
<p>execution(public * *(..))</p>
</blockquote>
<ul>
<li>任何执行的方法是以set开头的</li>
</ul>
<blockquote>
<p>execution(* set*(..))</p>
</blockquote>
<ul>
<li>任何执行的方法是AccountService中定义的</li>
</ul>
<blockquote>
<p>execution(* com.xyz.service.AccountService.*(..))</p>
</blockquote>
<ul>
<li>任何执行的方法是定义在service包中的</li>
</ul>
<blockquote>
<p>execution(* com.xyz.service.*.*(..))</p>
</blockquote>
<ul>
<li>任何执行的方法是定义在service包或者其子包中的</li>
</ul>
<blockquote>
<p>execution(* com.xyz.service..*.*(..))</p>
</blockquote>
<ul>
<li>任何在service包下的方法</li>
</ul>
<blockquote>
<p>within(com.xyz.service.*)</p>
</blockquote>
<ul>
<li>任何在service包或其子包下的方法</li>
</ul>
<blockquote>
<p>within(com.xyz.service..*)</p>
</blockquote>
<ul>
<li>任何方法的代理是实现<code>AccountService</code>接口的</li>
</ul>
<blockquote>
<p>this(com.xyz.service.AccountService)<br>
一般用于绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何方法的目标对象是实现<code>AccountService</code>接口的</li>
</ul>
<blockquote>
<p>target(com.xyz.service.AccountService)<br>
一般用于绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何执行的方法有一个参数，并且这个参数在运行时是通过<code>Serializable</code>传递的</li>
</ul>
<blockquote>
<p>args(java.io.Serializable)<br>
一般用于绑定接口，具体用法在后面会提到<br>
注意这里的参数匹配跟<code>execution(* *(java.io.Serializable))</code>是不同的<br>
args代表参数在运行时是以<code>Serializable</code>传递的<br>
execution代表参数必须是<code>Serializable</code>类型</p>
</blockquote>
<ul>
<li>任何方法的目标对象有<code>@Transactional</code>注解</li>
</ul>
<blockquote>
<p>@target(org.springframework.transaction.annotation.Transactional)<br>
你同样可以把他用在绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何方法的目标对象的申明类型有<code>@Transactional</code>注解</li>
</ul>
<blockquote>
<p>@within(org.springframework.transaction.annotation.Transactional)<br>
你同样可以把他用在绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何方法上有<code>@Transactional</code>注解</li>
</ul>
<blockquote>
<p>@annotation(org.springframework.transaction.annotation.Transactional)<br>
你同样可以把他用在绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何方法只有一个参数，并且该参数在运行时传递有<code>@Classified</code>注解</li>
</ul>
<blockquote>
<p>@args(com.xyz.security.Classified)<br>
你同样可以把他用在绑定结构，具体用法在后面会提到</p>
</blockquote>
<ul>
<li>任何方法所属的Spring bean的名称是<code>tradeService</code></li>
</ul>
<blockquote>
<p>bean(tradeService)</p>
</blockquote>
<ul>
<li>任何方法所属的Spring bean的名称是以<code>Service</code>结尾</li>
</ul>
<blockquote>
<p>bean(*Service)</p>
</blockquote>
<h3 id="235-写好pointcuts表达式">2.3.5 写好pointcuts表达式</h3>
<p>AspectJ不会直接采用你写的pointcut表达式，进行分析校验后，你的表达式会被重写<br>
关于表达式的顺序，AspectJ也会重排，意味着不需要担心你的表达式写法会影响匹配效率</p>
<p>但是你直接选用的pointcut标识符还是会对匹配效率造成影响，原则上应该选用搜索范围更小的定义 <br>
AspectJ的标识符可以分为三类：类型，范围，和上下文：(以下标识符包括Spring不支持的)</p>
<ul>
<li>类型：指定类型的连接点：<code>execution</code>,<code>get</code>,<code>set</code>,<code>call</code>,和<code>withcode</code></li>
<li>范围：指定范围内的连接点：<code>within</code>和<code>withcode</code></li>
<li>上下文：指定上下文：<code>this</code>,<code>target</code>,和<code>@annotation</code></li>
</ul>
<p>一个好的pointcut表达式至少要包含<code>类型</code>和<code>范围</code>两个类型<br>
如果只有<code>类型</code>和<code>上下文</code>，会影响性能，因为需要一些额外的处理和分析<br>
但是<code>范围</code>不同，他的匹配速度非常快，一个好的pointcut表达式应该尽可能的包含一个</p>
<h2 id="24-申明advice">2.4 申明Advice</h2>
<p>Advice需要关联一个pointcut表达式，并申明在匹配的pointcut之前(before)，之后(after)，或者前后(around)运行<br>
引用pointcut表达式可简单引用已命名的pointcut表达式，或者就地申明pointcut表达式</p>
<h3 id="241-before-advice">2.4.1 Before Advice</h3>
<p>你可以在一个切面类中申明<code>before advice</code>通过使用<code>@Before</code>注解:</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;

@Aspect
public class BeforeExample {

    @Before(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)
    public void doAccessCheck() {
        // ...
    }

}
</code></pre>
<p>如果我们不引用已声明的pointcut，可以直接就地申明：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;

@Aspect
public class BeforeExample {

    @Before(&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;)
    public void doAccessCheck() {
        // ...
    }

}
</code></pre>
<h3 id="242-after-returning-advice">2.4.2 After Returning Advice</h3>
<p><code>After Returning Advice</code>在方法正常<code>return</code>后运行。<br>
你可以申明它通过使用<code>@AfterReturning</code>注解：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterReturning;

@Aspect
public class AfterReturningExample {

    @AfterReturning(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)
    public void doAccessCheck() {
        // ...
    }

}
</code></pre>
<blockquote>
<p>你可以拥有多个<code>advice</code>，在同一个切面类中</p>
</blockquote>
<p>有些时候，你需要在advice方法中访问<em>目标方法</em>的返回值。你可以使用<code>@AfterReturning</code>的参数结构去绑定返回参数：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterReturning;

@Aspect
public class AfterReturningExample {

    @AfterReturning(
        pointcut=&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;,
        returning=&quot;retVal&quot;)
    public void doAccessCheck(Object retVal) {
        // ...
    }

}
</code></pre>
<p><code>returning</code>参数所用的名字，必须跟advice方法的参数名相同<br>
并且返回值的类型也必须匹配(这里用的Object，可匹配所有返回值)</p>
<p>注意想通过<code>after returning advice</code>返回一个完全不同的引用是不可能的</p>
<h3 id="243-after-throwing-advice">2.4.3 After Throwing Advice</h3>
<p><code>After Throwing Advice</code>当<code>目标方法</code>是因为抛出异常退出的时候执行。
可以通过<code>@AfterThrowing</code>注解来实现：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterThrowing;

@Aspect
public class AfterThrowingExample {

    @AfterThrowing(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)
    public void doRecoveryActions() {
        // ...
    }

}
</code></pre>
<p>在通常使用情况下，你可能需要在指定异常的时候运行Advice，或者获取方法抛出的异常（想获得异常，又不想限制，使用<code>Throwable</code>）<br>
你可以使用<code>@AfterThrowing</code>的属性<code>throwing</code>来实现：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterThrowing;

@Aspect
public class AfterThrowingExample {

    @AfterThrowing(
        pointcut=&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;,
        throwing=&quot;ex&quot;)
    public void doRecoveryActions(DataAccessException ex) {
        // ...
    }

}
</code></pre>
<p>同样<code>throwing</code>中的名字必须跟advice方法的参数名称相同<br>
当然也有类型限制，advice方法的参数类型，必须跟<em>目标方法</em>抛出的异常类型相同</p>
<h3 id="244-after-finally-advice">2.4.4 After (Finally) Advice</h3>
<p><code>After (Finally) Advice</code>是在<em>目标方法</em>执行退出后运行<br>
它通过注解<code>@After</code>来实现，用该注解的时候，你需要同时处理正常返回现象和异常退出现象<br>
这个Advice通常用来处理资源释放问题或者其他相似的情形：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.After;

@Aspect
public class AfterFinallyExample {

    @After(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation()&quot;)
    public void doReleaseLock() {
        // ...
    }

}
</code></pre>
<h3 id="245-around-advice">2.4.5 Around Advice</h3>
<p><code>Around Advice</code>是最后一个advice，也是最强大的一个。你可以在方法执行前，执行后做处理，甚至可以决定什么时候运行，怎样运行，是否运行<em>目标方法</em><br>
它经常使用的场景是在方法运行前后有状态信息需要分享的，比如方法的运行时间等等<br>
在选择Advice的时候，始终使用功能最弱的那个，比如能用Before，就不用Around</p>
<p><code>Around Advice</code>通过注解<code>@Around</code>来申明。advice方法的第一个参数类型必须是<code>ProceedingJoinPoint</code><br>
在advice方法中，通过调用第一个参数的<code>proceed()</code>方法，可以执行<em>目标方法</em><br>
<code>proceed</code>可以传递一个<code>Object[]</code>参数，这个数组，是<em>目标方法</em>所需要的所有参数 <br>
如何使用<code>Around Advice</code>？下面是一个例子：</p>
<pre><code class="language-java">import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.ProceedingJoinPoint;

@Aspect
public class AroundExample {

    @Around(&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;)
    public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable {
        // start stopwatch
        Object retVal = pjp.proceed();
        // stop stopwatch
        return retVal;
    }

}
</code></pre>
<p>around advice 的返回值就是方法调用者看到的返回值。举个例子，一个简单的缓存切面，如果缓存里面有直接从缓存返回，如果缓存里面没有再调用<code>proceed()</code>方法。<br>
注意<code>proceed</code>有可能调用一次，或者多次，甚至不调用，这都是合法的</p>
<h3 id="246-advice参数">2.4.6 advice参数</h3>
<h4 id="访问当前的-joinpoint">访问当前的 <code>JoinPoint</code></h4>
<p>任何的advice方法都可以申明<code>JoinPoint</code>作为第一个参数（除了<code>around</code>例外，不过它的第一个参数<code>ProceedingJoinPoint</code>，也是<code>JoinPoint</code>的子类)<br>
<code>JoinPoint</code>提供了一些很有用的方法：</p>
<ul>
<li><code>getArgs()</code>：返回方法参数</li>
<li><code>getThis()</code>：返回代理对象</li>
<li><code>getTarget()</code>：返回目标对象</li>
<li><code>getSignature()</code>：返回方法的描述</li>
<li><code>toString()</code>：打印方法有用的描述</li>
</ul>
<p>完整API参考<a href="https://www.eclipse.org/aspectj/doc/released/runtime-api/org/aspectj/lang/JoinPoint.html">javadoc</a></p>
<h4 id="给advice传递参数">给Advice传递参数</h4>
<p>我们已经看过怎样绑定返回值和异常值（通过使用<code>after returning</code>和<code>after throwing</code>advice)。那么参数值怎么绑定了，可以使用<code>args</code>表达式<br>
如果在args表达式里使用对应的advice方法的参数名代替类型名，当advice被调用时对应的参数就会被指定类型的原方法参数替换。<br>
举个例子，假如你的<em>目标方法</em>第一个参数是一个类型为<code>Account</code>的对象，你需要访问这个account参数在advice的方法体中，你可以像下面这样写：</p>
<pre><code class="language-java">@Before(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)&quot;)
public void validateAccount(Account account) {
    // ...
}
</code></pre>
<p><code>args(account,..)</code>这个pointcut表达式有两个目的</p>
<ol>
<li>限制<em>目标方法</em>至少有一个参数，并且这个参数是<code>Account</code>类的实例</li>
<li>通过advice参数传递参数的值</li>
</ol>
<p>传递参数的另外一个方法是在一个pointcut表达式里面申明好，advice直接引用：</p>
<pre><code class="language-java">@Pointcut(&quot;com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)&quot;)
private void accountDataAccessOperation(Account account) {}

@Before(&quot;accountDataAccessOperation(account)&quot;)
public void validateAccount(Account account) {
    // ...
}
</code></pre>
<p>this、target、@within、@target、@annotation，和@args都可以用同样的方式绑定<br>
下面的两个例子展示了如何匹配有注解<code>@Auditable</code>的方法和如何提取注解的<code>AuditCode</code>参数</p>
<p>第一个例子展示了<code>@Auditable</code>注解：</p>
<pre><code class="language-java">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface Auditable {
    AuditCode value();
}
</code></pre>
<p>第二个例子是对应的advice：</p>
<pre><code class="language-java">@Before(&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)&quot;)
public void audit(Auditable auditable) {
    AuditCode code = auditable.value();
    // ...
}
</code></pre>
<h4 id="advice参数和泛型">Advice参数和泛型</h4>
<p>Spring AOP可以处理类泛型和方法泛型<br>
假如你有一个接口如下所示：</p>
<pre><code class="language-java">public interface Sample&lt;T&gt; {
    void sampleGenericMethod(T param);
    void sampleGenericCollectionMethod(Collection&lt;T&gt; param);
}
</code></pre>
<p>你可以指定泛型为什么类型时才拦截方法：</p>
<pre><code class="language-java">@Before(&quot;execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)&quot;)
public void beforeSampleMethod(MyType param) {
    // Advice implementation
}
</code></pre>
<p>这个方法在泛型指向集合的时候是不生效的。所以你不能像下边那样定义pointcut：</p>
<pre><code class="language-java">@Before(&quot;execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)&quot;)
public void beforeSampleMethod(Collection&lt;MyType&gt; param) {
    // Advice implementation
}
</code></pre>
<p>要实现这种情况，你需要改变参数类型为<code>Collection&lt;?&gt;</code>，并且你需要手动校验集合中的每一个元素，这是不合理的，因为null值无法处理。</p>
<h4 id="确定参数名称">确定参数名称</h4>
<p>advice调用时的参数绑定是依赖于pointcut表达式里面的名称（用于申明advice参数名）和pointcut方法签名的名字相匹配，但是在java反射里边，参数名称是不可用的<br>
所以Spring AOP采用了以下策略却决定参数名称:</p>
<ul>
<li>如果参数名已经被用户明确指定，那么指定的参数名会被使用。advice和pointcut注解都有一个可选属性<code>argNames</code>，你可以用它指定注解方法的参数名称 <br>
这些参数名称在运行时也是可用的。下面这个例子展示了如何使用<code>argNames</code>属性：</li>
</ul>
<pre><code class="language-java">@Before(value=&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;,
        argNames=&quot;bean,auditable&quot;)
public void audit(Object bean, Auditable auditable){
    AuditCode code = auditable.value();
}
</code></pre>
<p>如果第一个参数是默认参数<code>JoinPoint</code>，<code>ProceedingJoinPoint</code>,或者<code>JoinPoint.StaticPart</code>，在配置<code>argNames</code>时你可以直接忽略这些默认参数<br>
举个例子，如果你修改上面的advice新增一个<code>JoinPoint</code>参数，<code>argNames</code>不需要涵盖它：</p>
<pre><code class="language-java">@Before(value=&quot;com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;,
        argNames=&quot;bean,auditable&quot;)
public void audit(JoinPoint joinPoint, Object bean, Auditable auditable){
    AuditCode code = auditable.value();
}
</code></pre>
<p>当advice方法只有默认参数<code>JoinPoint</code>，<code>PorceedingJoinPoint</code>，和<code>Joint.StaticPart</code>时，可以不写<code>argNames</code></p>
<pre><code class="language-java">@Before(&quot;com.xyz.lib.Pointcuts.anyPublicMethod()&quot;)
public void audit(JoinPoint jp) {
    // ... use jp
}
</code></pre>
<ul>
<li>
<p>使用<code>argNames</code>属性显得稍微有些笨拙，所以当<code>argNames</code>没有被指定时，Spring AOP将会在类的debug信息中查找，并从本地变量表中决定参数名称<br>
只要类编译时有debug信息(至少是<code>-g:vars</code>)就能得到这个信息。<br>
启用此标志进行编译的结果是：</p>
<ol>
<li>你的代码会更容易理解（反向工程）</li>
<li>class文件的大小会有轻微增大（一般可以忽略不计）</li>
<li>会移除编译器没有用到的本地变量</li>
</ol>
<p>换句话说，使用这个标志你不会碰见任何困难</p>
</li>
<li>
<p>如果代码被编译的时候没有必须的debug信息，Spring AOP会尝试推断参数的配对关系（举个例子，如果pointcut表达式里面只有一个参数绑定，而且advice也只有一个参数，那么这个配对关系就很明显）<br>
如果在可用的信息里面绑定参数是不确定的，那么<code>AmbiguousBindingException</code>异常将会抛出</p>
</li>
<li>
<p>如果上面的所有策略都失败了，那么<code>IllegalArgumentException</code>异常将会抛出</p>
</li>
</ul>
<h4 id="proceed方法如果带参数">proceed方法如果带参数</h4>
<p>之前提过如何写一个带参数的<code>proceed</code>调用。这个解决方法需要确保advice的签名按顺序绑定了<em>目标方法</em>的每一个参数</p>
<pre><code class="language-java">@Around(&quot;execution(List&lt;Account&gt; find*(..)) &amp;&amp; &quot; +
        &quot;com.xyz.myapp.CommonPointcuts.inDataAccessLayer() &amp;&amp; &quot; +
        &quot;args(accountHolderNamePattern)&quot;)
public Object preProcessQueryPattern(ProceedingJoinPoint pjp,
        String accountHolderNamePattern) throws Throwable {
    String newPattern = preProcess(accountHolderNamePattern);
    return pjp.proceed(new Object[] {newPattern});
}
</code></pre>
<p>无论如何都要像上面的例子一样绑定</p>
<h3 id="247-advice顺序">2.4.7 advice顺序</h3>
<p>当多个advice同时指向一个<em>目标方法</em>时，Spring AOP和AspectJ遵循同样的优先级规则：</p>
<ul>
<li>进入方法：优先级高的先执行（比如两个给定的<code>before</code>advice，优先级高的先执行）</li>
<li>离开方法：优先级高的后执行（比如两个给定的<code>after</code>advice，优先级高的后执行）</li>
</ul>
<p>当两个advice定义在不同的aspect类但指向同一个<em>目标方法</em>时，除非你在其他地方指定了，不然执行顺序是没有定义的。<br>
你可以直接控制执行的优先级顺序,有两个方式：</p>
<ol>
<li>aspect类实现<code>org.springframework.core.Ordered</code>接口</li>
<li>aspect类加注解<code>@Order</code><br>
两个切面<code>Ordered.getValue()</code>(或者注解的value)，谁的值更小，睡的优先级更高</li>
</ol>
<blockquote>
<p>从Spring Framework 5.2.7开始，如果advice方法都定义在同一个aspect类中并且都指向同一个<em>目标方法</em>，那么他们的优先级是基于他们的advice类型的<br>
按照如下的顺序，从高到低：<br>
<code>@Around</code>,<code>@Before</code>,<code>@After</code>,<code>@AfterReturning</code>,<code>@AfterThrowing</code><br>
但请注意因为Spring的<code>AspectJAfterAdvice</code>实现方式，任何在同一个切面类中的<code>@AfterReturning</code>或者<code>AfterThrowing</code>advice方法执行过后都会去执行<code>@After</code>advice方法<br>
当两个同样类型的advice(比如，两个<code>@After</code>advice方法)定义在同一个切面类中时，并且都指向同一个<em>目标方法</em>，这种情况下顺序是无法定义的<br>
因为没有办法从javac已经编译过的类反射中获取源码的申明顺序<br>
所以当遇到这种情况时，请考虑合并这两个advice方法，或者把重复advice方法提取到另外一个切面类中</p>
</blockquote>
<h2 id="25-introductions">2.5 Introductions</h2>
<p>Introductions(在AspectJ中叫做类型间声明) 让切面类可以申明<em>目标方法</em>所在对象实现指定接口，而且提供一个接口的实现类去代表那些对象</p>
<p>你可以创建一个introduction通过使用<code>@DeclareParents</code>注解。这个注解被用来申明匹配的类型有一个新的父类<br>
举个例子，给定接口叫做<code>UsageTracked</code>然后这个接口的实现类叫做<code>DefaultUsageTracked</code><br>
下面的切面申明了所有实现service的实现类也实现了<code>UsageTracked</code>接口（例如通过JMX公开统计信息）：</p>
<pre><code class="language-java">@Aspect
public class UsageTracking {

    @DeclareParents(value=&quot;com.xzy.myapp.service.*+&quot;, defaultImpl=DefaultUsageTracked.class)
    public static UsageTracked mixin;

    @Before(&quot;com.xyz.myapp.CommonPointcuts.businessService() &amp;&amp; this(usageTracked)&quot;)
    public void recordUsage(UsageTracked usageTracked) {
        usageTracked.incrementUseCount();
    }

}
</code></pre>
<h2 id="26-切面类实例化模型">2.6 切面类实例化模型</h2>
<p>默认情况下，对application context来说每个切面类都是单例的。AspectJ将其称作单实例模型。可以使用备用的生命周期来定义Aspect<br>
Spring 支持AspectJ的<code>perthis</code>和<code>pertarget</code>实例化模型<br>
暂不支持<code>percflow</code>,<code>percflowbelow</code>，和<code>pertypewithin</code></p>
<p>你可以申明一个<code>perthis</code>切面通过制定<code>perthis</code>语句在注解<code>@Aspect</code>中：</p>
<pre><code class="language-java">@Aspect(&quot;perthis(com.xyz.myapp.CommonPointcuts.businessService())&quot;)
public class MyAspect{
    private int someState;

    @Before(&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;)
    public void recordServiceUsage(){
        // ...
    }
}
</code></pre>
<p>在上面的例子中，<code>perthis</code>语句的作用就是每匹配一个service对象就创建一个切面实例。当一个service对象的方法被调用时，切面实例被第一次创建<br>
当service对象超出范围时，切面对象也会超出范围（暂不明白这里的超出范围指的是什么）<br>
在切面实例被创建之前，里面的advice方法不会被调用。只要切面实例被创建，并且service对象与一个切面关联的时候，advice才会在匹配的时候运行</p>
<p><code>pertarget</code>实例化模型的工作方式跟<code>perthis</code>完全相同</p>
<h2 id="27-一个完整的aop实例">2.7 一个完整的AOP实例</h2>
<p>当执行业务service的时候，有时候会因为并发原因失败（例如，一个因为获取悲观锁失败的操作）。如果重新尝试，很可能在下次尝试的时候成功<br>
当这种情况出现时，我们应该有一个明显的重试操作以避免向客户端发送<code>PessimisticLockingFailureException</code>。这个需求很明显跨越了多个service，很明显可以用切面来实现</p>
<p>因为我们需要多次执行<code>proceed</code>方法，所以我们肯定需要around advice：</p>
<pre><code class="language-java">@Aspect
public class ConcurrentOperationExecutor implements Ordered {

    private static final int DEFAULT_MAX_RETRIES = 2;

    private int maxRetries = DEFAULT_MAX_RETRIES;
    private int order = 1;

    public void setMaxRetries(int maxRetries) {
        this.maxRetries = maxRetries;
    }

    public int getOrder() {
        return this.order;
    }

    public void setOrder(int order) {
        this.order = order;
    }

    @Around(&quot;com.xyz.myapp.CommonPointcuts.businessService()&quot;)
    public Object doConcurrentOperation(ProceedingJoinPoint pjp) throws Throwable {
        int numAttempts = 0;
        PessimisticLockingFailureException lockFailureException;
        do {
            numAttempts++;
            try {
                return pjp.proceed();
            }
            catch(PessimisticLockingFailureException ex) {
                lockFailureException = ex;
            }
        } while(numAttempts &lt;= this.maxRetries);
        throw lockFailureException;
    }

}
</code></pre>
<p>注意上面的切面类实现了<code>Ordered</code>接口，所以我们设置切面类的优先级是高于事务的（我们想每次尝试都是一个新事务）<br>
<code>maxRetries</code>和<code>order</code>属性都由Spring配置<br>
主要的操作都发生在<code>doConcurrentOperation</code>around advice。注意，在当前情况，我们应用了重试逻辑在每个<code>businessService()</code>。如果运行抛出<code>PessimisticLockingFailureException</code>异常，就会进行重试操作，除非重新操作次数已经耗尽。</p>
<p>对应的Spring配置如下：</p>
<pre><code class="language-xml">&lt;aop:aspectj-autoproxy/&gt;
&lt;bean id=&quot;concurrentOperationExecutor&quot; class=&quot;com.xyz.myapp.service.impl.ConcurrentOperationExecutor&quot;&gt;
    &lt;property name=&quot;maxRetries&quot; value=&quot;3&quot;/&gt;
    &lt;property name=&quot;order&quot; value=&quot;100&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<p>提炼aspect让他只有在幂等操作的时候才重试（幂等：函数多次运行结果与一次运行结果相同），我们可以定义<code>Idempotent</code>注解：</p>
<pre><code class="language-java">import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Idempotent{}
</code></pre>
<p>现在可以使用<code>Idempotent</code>注解去标注需要重试的service 方法，同时我们的pointcut表达式也需要修改：</p>
<pre><code class="language-java">@Around(&quot;com.xyz.myapp.CommonPointcuts.businessService() &amp;&amp; &quot; +
        &quot;@annotation(com.xyz.myapp.service.Idempotent)&quot;)
public Object doConcurrentOperation(ProceedingJoinPoint pjp) throws Throwable {
    // ...
}
</code></pre>
<h1 id="3--基于架构的aop支持xml配置形式的">3.  基于架构的AOP支持（xml配置形式的）</h1>
<p>xml配置形式的AOP跟基于AspectJ的形，只是方式不一样，用的pointcut表达式都是一样的，这里不细讲，详细参考文末的官方文档</p>
<blockquote>
<p>详情参考 <a href="https://docs.spring.io/spring/docs/5.2.8.RELEASE/spring-framework-reference/core.html#aop">Spring官方文档</a></p>
</blockquote>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="http://www.mingaccount.com/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/" title="Spring切面编程" target="_blank" rel="external">http://www.mingaccount.com/2017/06/spring%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8Baop/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="http://www.mingaccount.com/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">Ming</span><small class="ml-1x">tianshiming5@outlook.com</small></a></h3>
        <div>Finally</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="http://www.mingaccount.com/2017/06/%E6%A0%B9%E6%8D%AEmethod%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E5%8F%82%E6%95%B0%E5%90%8D/" title="根据Method获取所有参数名"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="http://www.mingaccount.com/2017/07/mysql%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99/"
                    title="Mysql启动报错mkdir: cannot create directory ‘//.cache’: Permission denied"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="http://www.mingaccount.com/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2015  -
    2021
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="http://www.mingaccount.com/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="http://www.mingaccount.com/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'http:\/\/www.mingaccount.com',
            CONTENT_URL: 'http:\/\/www.mingaccount.com\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="http://www.mingaccount.com/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
